# Исправление проблемы с перезапуском контейнера Document Dealer

## Проблема: Контейнер постоянно перезапускается

### Шаг 1: Остановите перезапуск
docker compose down document-dealer

### Шаг 2: Удалите volume (если поврежден)
docker volume rm srv-server_document-dealer-data || true

### Шаг 3: Проверьте переменные окружения
cat .env

# Убедитесь, что:
# JWT_SECRET=32fbc0ea9082b33151327dd042cd3dffe2ab623f81e4dff4d2b8102f4889b60e
# N8N_WEBHOOK_URL=https://n8n.n8nvibeauto.ru/webhook/document-generator
# DATABASE_URL="file:./data/dev.db"

### Шаг 4: Исправьте docker-compose.yml если нужно
# Проверьте, что volume mapping правильный:
# volumes:
#   - ./document-dealer-data:/app/data

### Шаг 5: Запустите с пересозданием
docker compose up --build -d document-dealer

### Шаг 6: Мониторьте логи в реальном времени
docker compose logs -f document-dealer

### Шаг 7: Если все еще перезапускается, проверьте:

# 1. Права доступа к volume
ls -la document-dealer-data/

# 2. SQLite файл
ls -la document-dealer-data/dev.db || echo "Database file missing"

# 3. Попробуйте запустить без volume
docker compose run --rm document-dealer ls -la /app/data/

### Шаг 8: Если проблема с базой данных

# 1. Удалите volume полностью
docker compose down document-dealer
docker volume rm srv-server_document-dealer-data

# 2. Запустите заново (Prisma создаст новую БД)
docker compose up -d document-dealer

### Шаг 9: Если проблема с сетью

# 1. Проверьте, что n8n доступен
curl -f https://n8n.n8nvibeauto.ru/ || echo "n8n not accessible"

# 2. Проверьте webhook URL
curl -X POST https://n8n.n8nvibeauto.ru/webhook-test/docs -H "Content-Type: application/json" -d '{"test": "data"}'

### Шаг 10: Временное решение - запустите без volume

# 1. Остановите контейнер
docker compose down document-dealer

# 2. Измените docker-compose.yml:
# volumes: []  # Удалите volumes

# 3. Запустите
docker compose up -d document-dealer

# 4. Проверьте, работает ли без volumes
curl http://localhost:3002/api/health

# Если работает, проблема с volume mapping
