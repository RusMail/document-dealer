# Диагностика проблем с контейнером Document Dealer

## Проблема: Контейнер завершается с кодом 0, но не слушает порт

# Шаг 1: Проверьте подробные логи
docker compose logs document-dealer

# Шаг 2: Проверьте, что контейнер действительно завершается
docker compose ps

# Шаг 3: Проверьте переменные окружения в контейнере
docker compose exec document-dealer env

# Шаг 4: Проверьте, что база данных инициализируется
docker compose exec document-dealer ls -la /app/data/

# Шаг 5: Проверьте, что порт открыт
docker compose exec document-dealer netstat -tlnp | grep 3002 || echo "Port 3002 not listening"

# Шаг 6: Тестируйте Node.js
docker compose exec document-dealer node -e "console.log('Node.js works:', process.version)"

# Шаг 7: Проверьте Prisma подключение
docker compose exec document-dealer npx prisma db push --accept-data-loss

# Шаг 8: Если проблема с базой данных, проверьте SQLite файл
ls -la document-dealer-data/

# Шаг 9: Удалите volume и пересоздайте
docker compose down document-dealer
docker volume rm srv-server_document-dealer-data || true
docker compose up -d document-dealer

# Шаг 10: Мониторинг в реальном времени
docker compose logs -f document-dealer &
sleep 5
curl -v http://localhost:3002/api/health
kill %1

# Шаг 11: Если ничего не помогает, проверьте Dockerfile
# Убедитесь, что CMD правильно указан:
# CMD ["npm", "start"]

# Шаг 12: Проверьте package.json scripts
docker compose exec document-dealer cat package.json | grep -A 5 '"scripts"'
