# Исправление проблемы с дублированным docker-compose.yml

## Проблема: Два docker-compose.yml файла

# Шаг 1: Удалите docker-compose.yml из папки document-dealer
rm /srv/server/document-dealer/docker-compose.yml

# Шаг 2: Перейдите в основную папку
cd /srv/server

# Шаг 3: Добавьте document-dealer в основной docker-compose.yml
# Откройте файл:
nano docker-compose.yml

# Добавьте этот блок в раздел services:

document-dealer:
  build: ./document-dealer
  container_name: document_dealer
  restart: unless-stopped
  ports:
    - "3002:3002"
  environment:
    - NODE_ENV=production
    - PORT=3002
    - DATABASE_URL=file:./document-dealer/data/dev.db
    - JWT_SECRET=32fbc0ea9082b33151327dd042cd3dffe2ab623f81e4dff4d2b8102f4889b60e
    - N8N_WEBHOOK_URL=https://n8n.n8nvibeauto.ru/webhook/document-generator
    - CORS_ORIGIN=https://doc.n8nvibeauto.ru
  volumes:
    - ./document-dealer-data:/app/data
  networks:
    - caddy_net

# Шаг 4: Настройте Caddyfile (добавьте в /srv/server/Caddyfile)

# Добавьте:
doc.n8nvibeauto.ru {
    reverse_proxy document_dealer:3002
}

# Шаг 5: Перезагрузите Caddy
docker compose restart caddy

# Шаг 6: Запустите Document Dealer
docker compose up --build -d document-dealer

# Шаг 7: Проверьте статус
docker compose ps

# Шаг 8: Тестируйте
curl http://localhost:3002/api/health
curl -I https://doc.n8nvibeauto.ru

# Шаг 9: Если все еще проблемы, проверьте:
# 1. DNS: nslookup doc.n8nvibeauto.ru
# 2. Caddy логи: docker compose logs caddy
# 3. Document Dealer логи: docker compose logs document-dealer
